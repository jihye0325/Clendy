<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
     xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ</title>
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <!-- csrf 토큰 -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
	<style>
	#wrapper {display: flex;}
	#title, h6{ display: inline-block; margin-right: 15px; }
	ul, li{list-style: none; padding-left: 0;}
	a{text-decoration: none;}
	/* content */
	#content{  margin : 0px auto auto 11%; width: 850px;}
	/* searchArea */
	#searchArea{ display: flex; justify-content: right;}
	#searchFAQ{ width: 300px; height: 23px; display: inline-block; margin: 5px;}
	#finding{ background-color : white; width: 23px; height:23px;  cursor: pointer; border:0;} 
	#category{ margin-top : 40px; margin-bottom : 20px; }
	#categoryUl{ display: table; width: 100%; min-width: 850px; border: 1px solid #ddd;  border-left: none;  box-sizing: border-box;}
	#categoryUl li{display: table-cell;   width: 9.09%;}
	#categoryUl label { border-left: 1px solid #ddd; width: 100%; height: 30px; display: table; text-align: center; line-height:30px; cursor: pointer;}
	#categoryUl label:hover{ font-weight: bold; background-color: lightgrey;}
	/* FAQ area */
	.title ul{ height: 30px; border-top: 1px solid lightgray; margin: 0; border-bottom: 1px solid lightgray;}
	.title li{ font-weight: bold; display: table-cell;  text-align: center; line-height: 30px; }
	.FAQ_num { width : 120px; text-align: center;}
	.FAQ_content{ width : 720px; }
	.cursor {cursor:pointer;}
	.question{ height: 40px; }
	.question ul { border-bottom: 1px solid lightgray; margin : 0;}
	.question li{ display: table-cell; height: 40px; line-height: 40px;}
	.answer-wrapper { display : none; border-bottom: 1px solid lightgray;}
	.answer{ padding-left: 119px; margin:10px;}
	/* btn */
	.btnArea{ display: flex; justify-content: flex-end; width: 850px; padding-bottom: 15px;}
	.mOrd{ margin-right: 5px; border:0; background-color: lightgray; width : 40px; height : 25px;}
	/* insert btn */
	#insertBtn{ display: flex; justify-content: flex-end; padding-top:15px; padding-bottom: 15px;}
	#insertFAQ{ width: 55px; height: 30px; border: 0; background-color: #060032; color:white; text-align: center;  line-height: 30px; }
	</style>
	<link rel="stylesheet" href="/css/common/sidebar.css">
	<!-- 수정, 등록 성공여부 알림창 -->
	<script>
		const msg = '[[${ msg }]]';
		
		if(msg){
			alert(msg);
		}
	</script>
</head>
<body>
    <div th:replace="common/header.html"></div>

    <div id="wrapper">
        <div id="sidebar">
            <ul>
                <li><a class="sideA current" href="/CScenter/FAQ">FAQ</a></li>
                <li><a class="sideA " href="/CScenter/board">공지사항</a></li>
                <li><a class="sideA" href="/CScenter/personalQ">1:1문의</a></li>
            </ul>
        </div>
        <div id="content">
            <h3 id="title">FAQ</h3><h6>자주 묻는 질문</h6>
            <th:block sec:authorize="hasRole('ROLE_ADMIN')">
            <div id="insertBtn">
                <a id="insertFAQ" href="/CScenter/insertFAQ">등록</a>
            </div>
            </th:block>
            <div id="searchArea">
            	<form th:action="@{/CScenter/FAQ/search}" method="post">
	                <input type="text" id="searchFAQ" name="keyword" placeholder="제목, 내용 검색">
	                <button type="submit" id="finding">
	                <img style="width :23px; "src="/images/magnifying-glass-navy.png"></button>
            	</form>
            </div>   
            
            <div id="category">
                <ul id="categoryUl">
                    <li><label>주문</label></li>
                    <li><label>배송</label></li>
                    <li><label>교환/환불</label></li>
                    <li><label>적립금/쿠폰</label></li>
                    <li><label>회원관련</label></li>
                </ul>
            </div> 
            
            <div id="FAQList">
                <div class="title"><ul><li class="FAQ_num">번호</li><li class="FAQ_content">내용</li></ul></div>
                <div class="qna-detail-wrapper" >
                	<div class="qna-detail" th:each="faq, i : ${faqList}">
                	<form th:action="@{/CScenter/FAQ/modify}" method="post">
                	<input type="hidden" name="q_no" id="q_no" th:value=${faq.q_no}>
	                <div class=" question"><ul><li class="FAQ_num" th:text= "${i.count}"></li>
	                	<li class="FAQ_content cursor"><span th:text="${faq.q_title}"></span></li></ul></div>
	                <div class="answer-wrapper"><p class="answer" th:text="${faq.q_answer}"></p>
	                    <th:block sec:authorize="hasRole('ROLE_ADMIN')">
	                    <div class="btnArea">
	                    <button type="button" class="mOrd modify">수정</button>
	                    <button type="button" class="mOrd delete">삭제</button>
	                    </div>
	                    </th:block>
	                </div>
	                </form>
	                </div>
	                
                </div>
           
            </div>
        </div>
    </div>    

    <div th:replace="common/footer.html"></div>

    <script>
    	/* faq 답변 클릭 시 슬라이드 효과 */
    	$(document).on('click', '.question', function(){
            if($(this).next().css('display') == 'none'){
                $(this).next().slideUp();
                $(this).next().slideDown();
            }else if($(this).next().css('display') == 'block'){
                $(this).next().slideUp();
            }  
        });
    	
    	/* 검색시 검색keyword 체크*/
    	$("#finding img").click(function(){
    	if($("#searchFAQ").val() == ""){
    		alert("검색어를 입력해주세요.");
    		return false;
    	}
    });
    	$("#searchFAQ").keydown(function(key) {
    		if (key.keyCode == 13) {
	    		if($("#searchFAQ").val() == ""){
	        		alert("검색어를 입력해주세요.");
	        		return false;
	        	}
    		}
    	});

    	
    	/* 카테고리 별 faq 리스트 출력 */
    	$(document).on('click', '#categoryUl li', function(){

    		var category = $(this).text();
    		var categoryCode = 0;
    		if(category == "주문") categoryCode=1;
    		else if (category == "배송") categoryCode=2;
    		else if (category == "교환/환불") categoryCode=3;
    		else if (category == "적립금/쿠폰") categoryCode=4;
    		else if (category == "회원관련") categoryCode=5;

    		$.ajax({
				url : "/CScenter/FAQ/category/"+categoryCode,
				type : "get",
				dataType : "JSON",
			 success : function(data){
				 var html = '';
				if( data != null){
					var i = 1;
					for(let index in data){				
				  		html += '<form th:action="@{/CScenter/FAQ/modify}" method="post">'+
				  				'<input type="hidden" name="q_no" id="q_no" value="'+data[index].q_no+'">'+  
			                    '<div class="question"><ul><li class="FAQ_num">'+ i++ +'</li>'+
			                    '<li class="FAQ_content cursor"><span>'+data[index].q_title+ '</span></li></ul></div>'+
		                		'<div class="answer-wrapper"><p class="answer">'+ data[index].q_answer+'</p>' +
			                    '<div class="btnArea"><button type="button" class="mOrd modify">수정</button>'+
			                    '<button type="button" class="mOrd delete">삭제</button></div></div></form>';             
					}

					$(".qna-detail-wrapper").html(html);
				}else{
					alert("리스트를 불러오는데 실패했습니다.");
				}
			},
			error : function(e){
				console.log(e);
			}
			});
    	});
    	
    	/* faq 삭제 */
    	$(document).on('click', '.delete', function(){
    		var q_no = $(this).parent().parent().prev().prev().val();
    		var token = $("meta[name='_csrf']").attr("content");
    		var header = $("meta[name='_csrf_header']").attr("content");
    		console.log(q_no);
    		
    		$.ajax({
				url : "/CScenter/FAQ/delete",
				type : "post",
				data : {q_no:q_no},
				beforeSend : function(xhr)
	            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
					xhr.setRequestHeader(header, token);
	            },

			 	success : function(result){
				if( result == 0){
					alert("게시글 삭제에 실패하였습니다.");
					
				}else{
					alert("게시글 삭제에 성공하였습니다.");
					location.reload();
				}
			},
			error : function(e){
				console.log(e);
			}
			});
    	});
    	
    	/* faq 수정 - textarea 로 변경 */
    	$(document).on('click', '.modify', function(){
    		var question = $(this).parent().parent().prev().children().children().children();
            var answer = $(this).parent().prev();
            var questionBefore = question.text();
            var answerBefore = answer.text();
            
            
            $(this).parent().html("<input type='submit' class='complete' style='margin-right: 5px; border:0; background-color: lightgray; width : 65px; height : 25px;' value='수정완료'>");
            
            
            question.replaceWith('<input type="text" name="q_title" style="width:640px; line-height:20px; maxlength="100" value="'+questionBefore+'">');
            answer.replaceWith('<input type="text" name="q_answer" style="width: 640px; height: 80px; resize:none; margin-top:10px; margin-left:119px;" maxlength="500" value="'+answerBefore+'">');
            
    	});
    	
    	
    </script>   

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
</body>
</html>